######################################
# Templates
######################################
.docker_image_template:
  image:
    name: fedora:latest
    pull_policy: always
  tags:
    - docker
    - photon


######################################
# Stages
######################################
stages:
  - Dependencie Stage
  - Compose Stage
  - Lorax Stage
  - Upload Stage

######################################
# Dependencie Stage
######################################

download-requirements: 
  extends: .docker_image_template
  stage: Dependencie Stage
  script: sudo dnf install just ostree rpm-ostree lorax

######################################
# Compose Stage
######################################
compose-build:
  extends: .docker_image_template
  stage: Compose Stage
  script:
    - sudo just compose photon-pony
  needs:
    - download-requirements

######################################
# Lorax Stage
######################################
lorax-build:
  extends: .docker_image_template
  stage: Lorax Stage
  script: sudo just lorax photon-pony
  needs: 
    - compose-build

######################################
# Artefacts Stage
######################################
upload-iso:
  extends: .docker_image_template
  stage: Upload Stage Stage
  artifacts:
    paths:
      - iso/Fedora*
      - iso/KS-Fedora*

  needs:
    - lorax-build
